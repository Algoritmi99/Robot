<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HWPRobot: adc.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HWPRobot
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('adc_8h.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">adc.h File Reference<div class="ingroups"><a class="el" href="group__lib.html">lib</a> &raquo; <a class="el" href="group__io.html">io</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;<a class="el" href="adc__cfg_8h_source.html">cfg/io/adc/adc_cfg.h</a>&gt;</code><br />
<code>#include &lt;avr/io.h&gt;</code><br />
<code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
</div>
<p><a href="adc_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a2dcdab718d3e55b1d407969a4e31ce96"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8h.html#a2dcdab718d3e55b1d407969a4e31ce96">ADC_init</a> (const bool disableJTAG)</td></tr>
<tr class="memdesc:a2dcdab718d3e55b1d407969a4e31ce96"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize the AD converter library.  <a href="adc_8h.html#a2dcdab718d3e55b1d407969a4e31ce96">More...</a><br /></td></tr>
<tr class="separator:a2dcdab718d3e55b1d407969a4e31ce96"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a82a5c6a8174e7f40c61017879e522c45"><td class="memItemLeft" align="right" valign="top">uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8h.html#a82a5c6a8174e7f40c61017879e522c45">ADC_getFilteredValue</a> (const uint8_t channel)</td></tr>
<tr class="memdesc:a82a5c6a8174e7f40c61017879e522c45"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read the filtered value from the AD converter for a given channel.  <a href="adc_8h.html#a82a5c6a8174e7f40c61017879e522c45">More...</a><br /></td></tr>
<tr class="separator:a82a5c6a8174e7f40c61017879e522c45"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a690d803e2a3b4a34ec5097e19e0e06a8"><td class="memItemLeft" align="right" valign="top">uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="adc_8h.html#a690d803e2a3b4a34ec5097e19e0e06a8">ADC_getLastValue</a> (const uint8_t channel)</td></tr>
<tr class="memdesc:a690d803e2a3b4a34ec5097e19e0e06a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read the latest raw value (unfiltered) from the AD converter for a given channel.  <a href="adc_8h.html#a690d803e2a3b4a34ec5097e19e0e06a8">More...</a><br /></td></tr>
<tr class="separator:a690d803e2a3b4a34ec5097e19e0e06a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Library for interfacing with AD converter.</p>
<p>The AD converter library supports a moving average filter for each sampled channel. Configuration of the AD converter library is included in <a class="el" href="adc__cfg_8h.html">src/cfg/io/adc/adc_cfg.h</a> where size of the moving average filter (<a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a>), number of channels to be sampled (<a class="el" href="adc__cfg_8h.html#a18b5b8600b67ba3c5efd48f11c9692d8" title="Number of ADC channels to be sampled.">ADC_CHANNEL_COUNT</a>) and specification of channels (<a class="el" href="adc__cfg_8h.html#a2cb52a426bba6101d2b03b7b2120fc54" title="Maps the ADC_CHANNEL_COUNT virtual channel numbers to the ADMUX register values of the physical chann...">ADC_CHANNEL_INIT</a>) is given.</p>
<p>After calling <a class="el" href="adc_8h.html#a2dcdab718d3e55b1d407969a4e31ce96" title="Initialize the AD converter library.">ADC_init()</a> the ADC is setup to sample all given channels consecutively using the ADC complete interrupt. The ADC clock is set to a frequency of 62.5kHz which is the lowest possible frequency resulting in the least noise of sampled values. The first conversion takes 25 ADC clock cycles (400us). All following conversions take 13 ADC clock cycles each (208us).</p>
<p>Starting a conversion is triggered through timer 5 compare match ISR <code>TIMER5_COMPA_vect</code> (see <a class="el" href="time_task__isr_8_s_source.html">lib/tools/timeTask/timeTask_isr.S</a>) every two milliseconds. As soon as a conversion is finished (after 208us or 400us), the ADC complete ISR <code>ADC_vect</code> (see <a class="el" href="adc__isr_8_s_source.html">lib/io/adc/adc_isr.S</a>) is executed which reads the converted value and stores it in a data structure which contains the sampled values for each channel and their average value. The ISR then sets up the ADC for the conversion of the next channel which will be triggered by run of <code>TIMER5_COMPA_vect</code> after the next. So every two milliseconds, a single channel is sampled. This means that the frequency of sampling each channel depends on the number of overall channels to be sampled. Thus, each channel is sampled every <a class="el" href="adc__cfg_8h.html#a18b5b8600b67ba3c5efd48f11c9692d8" title="Number of ADC channels to be sampled.">ADC_CHANNEL_COUNT</a> * 2ms.</p>
<p>The latest sampled raw value for a given channel can be requested with <a class="el" href="adc_8h.html#a690d803e2a3b4a34ec5097e19e0e06a8" title="Read the latest raw value (unfiltered) from the AD converter for a given channel.">ADC_getLastValue()</a>. Note that the age of this value is in the worst case about <a class="el" href="adc__cfg_8h.html#a18b5b8600b67ba3c5efd48f11c9692d8" title="Number of ADC channels to be sampled.">ADC_CHANNEL_COUNT</a> * 2ms.</p>
<p>The filtered sample can be read with <a class="el" href="adc_8h.html#a82a5c6a8174e7f40c61017879e522c45" title="Read the filtered value from the AD converter for a given channel.">ADC_getFilteredValue()</a>. This is a result of applying a moving average filter to the latest <a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a> samples. Note that the first meaningful value can be obtained after the ADC has sampled a channel at least <a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a> times. Thus, measured from the time when <a class="el" href="adc_8h.html#a2dcdab718d3e55b1d407969a4e31ce96" title="Initialize the AD converter library.">ADC_init()</a> was called and interrupts were globally enabled, the first readout of the filtered value should occur no earlier than (<a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a> * <a class="el" href="adc__cfg_8h.html#a18b5b8600b67ba3c5efd48f11c9692d8" title="Number of ADC channels to be sampled.">ADC_CHANNEL_COUNT</a> * 2ms) + 2ms.</p>
<p>Note that filtering introduces a time delay. The group delay of the moving average filter is exactly (<a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a> - 1) / 2 samples or (<a class="el" href="adc__cfg_8h.html#a84704f89dac62ee87776cbbd55698bed" title="Size of the moving average filter for each ADC channel.">ADC_FILTER_SIZE</a> - 1) / 2 * <a class="el" href="adc__cfg_8h.html#a18b5b8600b67ba3c5efd48f11c9692d8" title="Number of ADC channels to be sampled.">ADC_CHANNEL_COUNT</a> * 2ms.</p>
<p>The JTAG interface is enabled by default up on a power cycle. When enabled, the pins PF4 to PF7 (TCK, TMS, TDO, TDI) which also have the alternate functions ADC4 to ADC7 can only be used for the JTAG interface. In this situation all these pins are pulled high by the hardware and cannot be used by the ADC.</p>
<p>In order to allow their usage by the ADC, the JTAG can be switched off by calling <a class="el" href="adc_8h.html#a2dcdab718d3e55b1d407969a4e31ce96" title="Initialize the AD converter library.">ADC_init()</a> with the argument true. The JTD bit of the register MCUCR is then used to turn off the JTAG interface. </p>

<p class="definition">Definition in file <a class="el" href="adc_8h_source.html">adc.h</a>.</p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a2dcdab718d3e55b1d407969a4e31ce96"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2dcdab718d3e55b1d407969a4e31ce96">&#9670;&nbsp;</a></span>ADC_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ADC_init </td>
          <td>(</td>
          <td class="paramtype">const bool&#160;</td>
          <td class="paramname"><em>disableJTAG</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize the AD converter library. </p>
<p>Global interrupts must be enabled manually after calling this function.</p>
<p>See <a class="el" href="adc__cfg_8h.html">src/cfg/io/adc/adc_cfg.h</a> for configuration of the AD converter library.</p>
<p>The parameter disableJTAG allows disabling the JTAG interface, so that pins PF4 to PF7 (ADC4 to ADC7) can be used for AD conversions.</p>
<p>Note that the JTAG interface is enabled by default up on a power cycle. When enabled, the pins PF4 to PF7 (TCK, TMS, TDO, TDI) which also have the alternate functions ADC4 to ADC7 can only be used for the JTAG interface. In this situation all these pins are pulled high by the hardware.</p>
<p>In order to allow their usage by the ADC, the JTAG needs to be switched off using the JTD bit of the register MCUCR. A timed sequence is necessary in which the new value of MCUCR must be written twice within four clock cycles. Thus, interrupts will be disabled before and re-enabled afterwards if they were enabled before.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">disableJTAG</td><td>true to disable JTAG and allow pins ADC4 to ADC7 to be used by the ADC, false to keep JTAG enabled </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="adc_8c_source.html#l00046">46</a> of file <a class="el" href="adc_8c_source.html">adc.c</a>.</p>

</div>
</div>
<a id="a82a5c6a8174e7f40c61017879e522c45"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a82a5c6a8174e7f40c61017879e522c45">&#9670;&nbsp;</a></span>ADC_getFilteredValue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t ADC_getFilteredValue </td>
          <td>(</td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>channel</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read the filtered value from the AD converter for a given channel. </p>
<p>For the configuration of the moving average filter, see the user configuration in <a class="el" href="adc__cfg_8h.html">src/cfg/io/adc/adc_cfg.h</a>.</p>
<p>If enabled, interrupts are disabled during this function and their state restored afterwards.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">channel</td><td>the virtual channel number (see <a class="el" href="adc__cfg_8h.html#a2cb52a426bba6101d2b03b7b2120fc54" title="Maps the ADC_CHANNEL_COUNT virtual channel numbers to the ADMUX register values of the physical chann...">ADC_CHANNEL_INIT</a>) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the filtered digital value (10 bits) </dd></dl>

<p class="definition">Definition at line <a class="el" href="adc_8c_source.html#l00111">111</a> of file <a class="el" href="adc_8c_source.html">adc.c</a>.</p>

</div>
</div>
<a id="a690d803e2a3b4a34ec5097e19e0e06a8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a690d803e2a3b4a34ec5097e19e0e06a8">&#9670;&nbsp;</a></span>ADC_getLastValue()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t ADC_getLastValue </td>
          <td>(</td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>channel</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read the latest raw value (unfiltered) from the AD converter for a given channel. </p>
<p>If enabled, interrupts are disabled during this function and their state restored afterwards.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">channel</td><td>the virtual channel number (see <a class="el" href="adc__cfg_8h.html#a2cb52a426bba6101d2b03b7b2120fc54" title="Maps the ADC_CHANNEL_COUNT virtual channel numbers to the ADMUX register values of the physical chann...">ADC_CHANNEL_INIT</a>) </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the latest raw digital value (10 bits) </dd></dl>

<p class="definition">Definition at line <a class="el" href="adc_8c_source.html#l00133">133</a> of file <a class="el" href="adc_8c_source.html">adc.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_5d0aa56803c8250a5d891761f6bfc5c7.html">io</a></li><li class="navelem"><a class="el" href="dir_4c3a6decbf3115980a86ec6f516d0419.html">adc</a></li><li class="navelem"><a class="el" href="adc_8h.html">adc.h</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
